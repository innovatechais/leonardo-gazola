{
  "contents": [
    {
      "role": "user",
      "parts": [
        {
          "inlineData": {
            "mimeType": "{{ $('Baixar imagem').item.binary.data.mimeType }}",
            "data": "{{$('Extract from File').item.json.data}}"
          }
        },
        {
          "text": "<prompt>\n  <objetivo>Analise a imagem do canhoto e retorne somente o JSON abaixo.</objetivo>\n  <obrigatorio>OBRIGATÓRIO preencher todos os campos conforme regras.</obrigatorio>\n\n  <regras>\n    <secao id=\"1_pedido_numero\">\n      <regra>Procure o rótulo \"PEDIDO\".</regra>\n      <regra>O valor são 5–9 dígitos (ex.: 4526427).</regra>\n      <regra>Remova pontos, espaços e hífens; devolva apenas dígitos.</regra>\n      <regra>Se não encontrar, devolva null (nunca string vazia).</regra>\n    </secao>\n\n    <secao id=\"2_empresa_carimbo\">\n      <regra>Extraia o maior texto do carimbo físico (tinta/impressão por contato). Priorize razão social / nome fantasia.</regra>\n      <regra>Se houver mais de uma linha, devolva apenas a principal (linha com maior altura de fonte/área de caixa delimitadora).</regra>\n      <regra>Se carimbo_presente = false ou texto ilegível, devolva null.</regra>\n    </secao>\n\n    <secao id=\"3_data_entrega\">\n      <regra>Data manuscrita ou carimbada no formato DD/MM/AAAA ou DD/MM.</regra>\n      <regra>Se ausente, null.</regra>\n    </secao>\n\n    <secao id=\"4_assinatura_presente\">\n      <regra>true se existir qualquer traço manuscrito fora da área de data; caso contrário false.</regra>\n    </secao>\n\n    <secao id=\"5_flags_de_presenca\">\n      <data_entrega_presente>Defina como true se a data existe (mesmo que ilegível/sobreposta); caso contrário false.</data_entrega_presente>\n\n      <carimbo_presente>\n        <descricao>Determinar PRIMEIRO se há carimbo; SOMENTE SE carimbo_presente = true tentar extrair empresa_carimbo.</descricao>\n\n        <pipeline>\n          <fase1_detectar_carimbo>\n            <objetivo>Decidir se existe carimbo mesmo SEM moldura/borda e possivelmente SOBREPOSTO a rótulos/linhas.</objetivo>\n\n            <adverse_cases>\n              <sem_borda_ou_moldura>true</sem_borda_ou_moldura>\n              <sobreposto_a_rotulos_ou_linhas>true</sobreposto_a_rotulos_ou_linhas>\n              <atravessa_caixas_da_grade>true</atravessa_caixas_da_grade>\n              <opacidade_irregular_ou_cinza>true</opacidade_irregular_ou_cinza>\n              <bordas_suaves_sombra_dupla>true</bordas_suaves_sombra_dupla>\n              <rotacao_ou_desalinhamento_leve>true</rotacao_ou_desalinhamento_leve>\n              <quebra_de_baseline_ou_espacamento_irregular>true</quebra_de_baseline_ou_espacamento_irregular>\n              <ruido_ou_vazamento_de_tinta>true</ruido_ou_vazamento_de_tinta>\n            </adverse_cases>\n\n            <true_when>\n              <visual>\n                <aparencia_tinta_contato>true</aparencia_tinta_contato>               <!-- não parece tipografia vetorial do template -->\n                <tinta_por_cima_do_template>true</tinta_por_cima_do_template>         <!-- traços do carimbo por cima de linhas/rótulos -->\n                <cruza_linhas_de_caixa>true</cruza_linhas_de_caixa>                   <!-- caracteres cruzam bordas de caixas -->\n                <espessura_irregular>true</espessura_irregular>                       <!-- variação por pressão/contato -->\n                <opacidade_variavel>true</opacidade_variavel>                         <!-- partes claras/escuras -->\n                <leve_desregistro_ou_fantasma>true</leve_desregistro_ou_fantasma>     <!-- ghosting/double-strike -->\n              </visual>\n              <textual>\n                <predominancia_maiusculas>true</predominancia_maiusculas>\n                <tokens_de_empresa>LTDA|ME|EIRELI|S.A.|CNPJ|IE|END|TEL|IND|COMERCIAL|DISTRIBUIDORA|FARMACIA|FARMÁCIA|SUPERMERCADO|MERCADO</tokens_de_empresa>\n                <frase_semelhante_a_nome>sequencia_de_8+_caracteres_ou_frase_com_2+_palavras</frase_semelhante_a_nome>\n              </textual>\n              <layout>\n                <espalha_varias_celulas>true</espalha_varias_celulas>\n                <nao_segue_grade>true</nao_segue_grade>\n              </layout>\n            </true_when>\n\n            <false_when>\n              <rotulos_do_template>PEDIDO|NF-e|SÉRIE|DATA DE RECEBIMENTO|IDENTIFICAÇÃO E ASSINATURA DO RECEBEDOR|RECEBEMOS DE</rotulos_do_template>\n              <tipografia_fina_homogenea_do_formulario>true</tipografia_fina_homogenea_do_formulario>\n              <apenas_digitos_em_caixas>true</apenas_digitos_em_caixas>\n              <marca_dagua_ou_fundo>true</marca_dagua_ou_fundo>\n            </false_when>\n\n            <scoring>\n              <pontos_visuais>\n                <rule id=\"tinta_por_cima_do_template\">+2</rule>\n                <rule id=\"cruza_linhas_de_caixa\">+1</rule>\n                <rule id=\"espessura_irregular\">+1</rule>\n                <rule id=\"leve_desregistro_ou_fantasma\">+1</rule>\n              </pontos_visuais>\n              <pontos_textuais>\n                <rule id=\"predominancia_maiusculas\">+1</rule>\n                <rule id=\"tokens_de_empresa\">+2</rule>\n                <rule id=\"frase_semelhante_a_nome\">+1</rule>\n              </pontos_textuais>\n              <pontos_layout>\n                <rule id=\"espalha_varias_celulas\">+1</rule>\n                <rule id=\"nao_segue_grade\">+1</rule>\n              </pontos_layout>\n              <limiar>4</limiar>\n              <decisao>true_se_total_de_pontos_>=_limiar_E_nao_houver_false_when</decisao>\n            </scoring>\n          </fase1_detectar_carimbo>\n\n          <fase2_extrair_nome condicao=\"executar_se_carimbo_presente_true\">\n            <construcao_de_candidatos>\n              <origem>blocos_OCR_na_regiao_do_carimbo_ou_bloco_mais_proeminente_da_imagem</origem>\n              <filtros_negativos>excluir_blocos_com_apenas_digitos; excluir_blocos_que_sejam_apenas_rotulos_do_template; excluir_blocos_muito_pequenos</filtros_negativos>\n            </construcao_de_candidatos>\n            <pontuacao>\n              <altura_fonte_ou_area_da_caixa>+2</altura_fonte_ou_area_da_caixa>\n              <tokens_de_empresa>+2</tokens_de_empresa>\n              <predominancia_maiusculas>+1</predominancia_maiusculas>\n              <comprimento_util_8+>+1</comprimento_util_8+>\n              <proximidade_a_rotulos_relevantes>(RECEBEMOS|IDENTIFICACAO|ASSINATURA):+1</proximidade_a_rotulos_relevantes>\n            </pontuacao>\n            <selecao>escolha_o_candidato_com_maior_pontuacao; se_empate, escolha_o_de_maior_altura_de_fonte</selecao>\n            <pos_processamento>manter_diacriticos; aparar_espacos; remover_repeticoes_de_espacos; reportar_somente_a_linha_principal</pos_processamento>\n            <falha>se_nenhum_candidato_adequado, devolver_null</falha>\n          </fase2_extrair_nome>\n        </pipeline>\n      </carimbo_presente>\n    </secao>\n  </regras>\n\n  <saida_exclusiva>\n{\n  \\\"assinatura_presente\\\": true/false,\n  \\\"carimbo_presente\\\": true/false,\n  \\\"data_entrega_presente\\\": true/false,\n  \\\"data_entrega\\\": \\\"DD/MM/AAAA\\\" | \\\"DD/MM\\\" | null,\n  \\\"empresa_carimbo\\\": \\\"Nome da empresa\\\" | null,\n  \\\"pedido_numero\\\": \\\"########\\\" | null\n}\n  </saida_exclusiva>\n\n  <importante>\n    <ignorar>Ignore Nº NF-e, Série, CNPJ e chave de 44 dígitos.</ignorar>\n    <foco>Concentre-se apenas nos campos do canhoto.</foco>\n    <saida>Não inclua comentários, texto extra ou formatação Markdown.</saida>\n  </importante>\n</prompt>"
        }
      ]
    }
  ]
}
