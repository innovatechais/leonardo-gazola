# Story 1.3: Block Composer

## Status

Ready for Review

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: [pattern_validation, integration_review]

## Story

**As a** NEXUS operator,
**I want** to compose modular blocks by combining substrates per funnel stage,
**so that** I have reusable pieces ready to assemble any output.

## Acceptance Criteria

1. Comando `*block create {id}` inicia elicitaÃ§Ã£o: tÃ­tulo, etapa de funil, substratos que compÃµem
2. Bloco gerado concatenando substratos referenciados
3. Comando `*block list` exibe blocos agrupados por etapa de funil
4. Comando `*block view {id}` mostra conteÃºdo + referÃªncias (rastreabilidade)
5. Blocos afetados por ediÃ§Ã£o de substrato mostram flag `[STALE]`
6. Blocos armazenados em `docs/knowledge/{project}/blocks/{stage}-{slug}.md`
7. Blocos seed para Evidex: A1_ProblemaCanhoto, C1_SolucaoEvidex, D1_OfertaPrecos

## ðŸ¤– CodeRabbit Integration

> **CodeRabbit Integration**: Disabled

## Tasks / Subtasks

- [x] Task 1: Implementar Block Composer (AC: 1, 2, 5, 6)
  - [x] 1.1 Criar `src/sca-engine/composer.js`: composeBlock, checkStaleness, writeBlock, markStale
  - [x] 1.2 BlockFrontmatter jÃ¡ existia em schemas.js (Story 1.1)
- [x] Task 2: Implementar CLI Block commands (AC: 1, 3, 4)
  - [x] 2.1 Criar `src/cli/block.js` â€” Commander: `create`, `list`, `view`
  - [x] 2.2 Lista agrupada por funnel stage com Ã­cones
  - [x] 2.3 View mostra conteÃºdo + footer com substratos referenciados
- [x] Task 3: Seed data Evidex (AC: 7)
  - [x] 3.1 Criar `docs/knowledge/evidex/blocks/A1-problema-canhoto.md` â€” S1, S2
  - [x] 3.2 Criar `docs/knowledge/evidex/blocks/C1-solucao-evidex.md` â€” S1, S3
  - [x] 3.3 Criar `docs/knowledge/evidex/blocks/D1-oferta-precos.md` â€” S1, S4
- [x] Task 4: Testes (AC: todos)
  - [x] 4.1 `tests/sca-engine/composer.test.js` â€” 6 tests (compose, staleness, broken refs, markStale)
  - [x] 4.2 Fixtures: A1-valid.md, C1-stale.md, D1-broken-ref.md
- [x] Task 5: ValidaÃ§Ã£o final
  - [x] 5.1 71/71 testes passando, lint limpo

## Dev Notes

### DependÃªncia

**Depende de Story 1.2** â€” usa parser.js, validator.js, writer.js do SCA Engine.

### Arquitetura Relevante

**BlockFrontmatter Schema** [Source: architecture/nexus-architecture-v1.md#4.3]:
```javascript
const FunnelStage = z.enum(['awareness', 'consideration', 'decision', 'loyalty'])

const BlockFrontmatter = z.object({
  id: z.string().regex(/^[ACDL]\d+$/),
  title: z.string().min(1),
  funnel_stage: FunnelStage,
  substrates: z.array(z.string().regex(/^S\d+$/)).min(1),
  version: z.number().int().positive().default(1),
  status: z.enum(['current', 'stale', 'deprecated']).default('current'),
  compiled_at: z.string().datetime(),
})
```

**Block File Format** [Source: architecture/nexus-architecture-v1.md#9.2]:
```yaml
---
id: A1
title: "Problema do Canhoto"
funnel_stage: awareness
substrates: [S1, S2, S5]
version: 1
status: current
compiled_at: 2026-02-25T00:00:00Z
---
{conteÃºdo compilado â€” concatenaÃ§Ã£o dos substratos referenciados}
```

**Naming:** `{stage}{n}-{slug}.md` â€” stage letter maps: awarenessâ†’A, considerationâ†’C, decisionâ†’D, loyaltyâ†’L

**Staleness Detection:** Bloco fica stale quando `compiled_at` < `updated_at` de qualquer substrato referenciado.

**Composer Interface** [Source: architecture/nexus-architecture-v1.md#6.1]:
- `composeBlock(blockDef, project)` â†’ `{ compiledContent, substrates[], staleness }`

### Testing

- Framework: Vitest, globals: true
- Location: `tests/sca-engine/`
- Fixtures: `tests/fixtures/blocks/`
- Test cases: compose vÃ¡lido, staleness detection, broken reference handling

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-25 | 0.1 | Story criada | River (SM) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
- Nenhum issue â€” lint e testes passaram de primeira
- Substratos S3 e S4 adicionais criados para Evidex (necessÃ¡rios para os blocos seed)

### Completion Notes List
- 71/71 testes (6 novos), lint limpo
- Todos os 7 ACs implementados
- Composer: composeBlock, checkStaleness, writeBlock, markStale
- CLI: block create/list/view com agrupamento por funnel stage
- 3 blocos seed Evidex + 2 substratos adicionais (S3, S4)

### File List
| File | Action | Description |
|------|--------|-------------|
| `src/sca-engine/composer.js` | Created | Block composer with staleness detection |
| `src/sca-engine/index.js` | Modified | Added composer exports |
| `src/cli/block.js` | Created | CLI: create, list, view blocks |
| `src/cli/index.js` | Modified | Added block command |
| `docs/knowledge/evidex/substrates/S3-solucao-tecnica.md` | Created | Seed substrate |
| `docs/knowledge/evidex/substrates/S4-oferta-comercial.md` | Created | Seed substrate |
| `docs/knowledge/evidex/blocks/A1-problema-canhoto.md` | Created | Seed block |
| `docs/knowledge/evidex/blocks/C1-solucao-evidex.md` | Created | Seed block |
| `docs/knowledge/evidex/blocks/D1-oferta-precos.md` | Created | Seed block |
| `tests/sca-engine/composer.test.js` | Created | 6 composer tests |
| `tests/fixtures/blocks/A1-valid.md` | Created | Test fixture |
| `tests/fixtures/blocks/C1-stale.md` | Created | Test fixture |
| `tests/fixtures/blocks/D1-broken-ref.md` | Created | Test fixture |

## QA Results
_To be filled by QA agent_
