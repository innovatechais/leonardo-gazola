# Story 1.3: Block Composer

## Status

Draft

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: [pattern_validation, integration_review]

## Story

**As a** NEXUS operator,
**I want** to compose modular blocks by combining substrates per funnel stage,
**so that** I have reusable pieces ready to assemble any output.

## Acceptance Criteria

1. Comando `*block create {id}` inicia elicitaÃ§Ã£o: tÃ­tulo, etapa de funil, substratos que compÃµem
2. Bloco gerado concatenando substratos referenciados
3. Comando `*block list` exibe blocos agrupados por etapa de funil
4. Comando `*block view {id}` mostra conteÃºdo + referÃªncias (rastreabilidade)
5. Blocos afetados por ediÃ§Ã£o de substrato mostram flag `[STALE]`
6. Blocos armazenados em `docs/knowledge/{project}/blocks/{stage}-{slug}.md`
7. Blocos seed para Evidex: A1_ProblemaCanhoto, C1_SolucaoEvidex, D1_OfertaPrecos

## ðŸ¤– CodeRabbit Integration

> **CodeRabbit Integration**: Disabled

## Tasks / Subtasks

- [ ] Task 1: Implementar Block Composer (AC: 1, 2, 5, 6)
  - [ ] 1.1 Criar `src/sca-engine/composer.js`:
    - `composeBlock(blockDef, project)` â†’ `{ compiledContent, substrates[], staleness }`
    - `checkStaleness(block, project)` â†’ boolean (compara compiled_at com updated_at dos substratos)
    - `markStale(blockPath)` â†’ atualiza frontmatter status para 'stale'
  - [ ] 1.2 Adicionar `BlockFrontmatter` ao `src/shared/schemas.js` (se nÃ£o existir)
- [ ] Task 2: Implementar CLI Block commands (AC: 1, 3, 4)
  - [ ] 2.1 Criar `src/cli/block.js` â€” Commander: `create`, `list`, `view`
  - [ ] 2.2 Lista agrupada por funnel stage com Ã­cones (ðŸ”µ awareness, ðŸŸ¡ consideration, ðŸŸ¢ decision, ðŸŸ£ loyalty)
  - [ ] 2.3 View mostra conteÃºdo + footer com substratos referenciados
- [ ] Task 3: Seed data Evidex (AC: 7)
  - [ ] 3.1 Criar `docs/knowledge/evidex/blocks/A1-problema-canhoto.md` â€” referencia S1, S2 (Evidex)
  - [ ] 3.2 Criar `docs/knowledge/evidex/blocks/C1-solucao-evidex.md` â€” referencia S1, S3
  - [ ] 3.3 Criar `docs/knowledge/evidex/blocks/D1-oferta-precos.md` â€” referencia S1, S4, S8
- [ ] Task 4: Testes (AC: todos)
  - [ ] 4.1 `tests/sca-engine/composer.test.js` â€” compose, staleness check, broken refs
  - [ ] 4.2 Fixtures: `tests/fixtures/blocks/A1-valid.md`, `C1-stale.md`, `D1-broken-ref.md`
- [ ] Task 5: ValidaÃ§Ã£o final
  - [ ] 5.1 `npm run validate` passa

## Dev Notes

### DependÃªncia

**Depende de Story 1.2** â€” usa parser.js, validator.js, writer.js do SCA Engine.

### Arquitetura Relevante

**BlockFrontmatter Schema** [Source: architecture/nexus-architecture-v1.md#4.3]:
```javascript
const FunnelStage = z.enum(['awareness', 'consideration', 'decision', 'loyalty'])

const BlockFrontmatter = z.object({
  id: z.string().regex(/^[ACDL]\d+$/),
  title: z.string().min(1),
  funnel_stage: FunnelStage,
  substrates: z.array(z.string().regex(/^S\d+$/)).min(1),
  version: z.number().int().positive().default(1),
  status: z.enum(['current', 'stale', 'deprecated']).default('current'),
  compiled_at: z.string().datetime(),
})
```

**Block File Format** [Source: architecture/nexus-architecture-v1.md#9.2]:
```yaml
---
id: A1
title: "Problema do Canhoto"
funnel_stage: awareness
substrates: [S1, S2, S5]
version: 1
status: current
compiled_at: 2026-02-25T00:00:00Z
---
{conteÃºdo compilado â€” concatenaÃ§Ã£o dos substratos referenciados}
```

**Naming:** `{stage}{n}-{slug}.md` â€” stage letter maps: awarenessâ†’A, considerationâ†’C, decisionâ†’D, loyaltyâ†’L

**Staleness Detection:** Bloco fica stale quando `compiled_at` < `updated_at` de qualquer substrato referenciado.

**Composer Interface** [Source: architecture/nexus-architecture-v1.md#6.1]:
- `composeBlock(blockDef, project)` â†’ `{ compiledContent, substrates[], staleness }`

### Testing

- Framework: Vitest, globals: true
- Location: `tests/sca-engine/`
- Fixtures: `tests/fixtures/blocks/`
- Test cases: compose vÃ¡lido, staleness detection, broken reference handling

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-25 | 0.1 | Story criada | River (SM) |

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results
_To be filled by QA agent_
