# Story 1.4: Context Generator (SCA Output Engine)

## Status

Ready for Review

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: [integration_review, pattern_validation]

## Story

**As a** NEXUS operator,
**I want** to generate compiled context ready to feed any squad,
**so that** agents receive relevant substrates + blocks automatically.

## Acceptance Criteria

1. Comando `*context generate {project} --for {squad}` produz `context.md`
2. Mapeamento em `config/squad-context-map.yaml` define quais categorias cada squad precisa
3. O `context.md` inclui: header, substratos relevantes, blocos compilados, instruÃ§Ãµes
4. Comando `*context preview` mostra preview sem salvar (dry-run)
5. Salvo em `docs/knowledge/{project}/contexts/{squad}-context.md`
6. Valida que substratos existem e nenhum bloco estÃ¡ `[STALE]`

## ðŸ¤– CodeRabbit Integration

> **CodeRabbit Integration**: Disabled

## Tasks / Subtasks

- [x] Task 1: Implementar Context Generator (AC: 1, 2, 3, 5, 6)
  - [x] 1.1 Criar `src/sca-engine/context-generator.js` â€” all functions
  - [x] 1.2 ValidaÃ§Ã£o: stale blocks como warning
- [x] Task 2: Criar config file (AC: 2)
  - [x] 2.1 Criar `config/squad-context-map.yaml` com 5 squads
- [x] Task 3: Implementar CLI Context commands (AC: 1, 4)
  - [x] 3.1 Criar `src/cli/context.js` â€” generate, preview
  - [x] 3.2 Preview mode dry-run
- [x] Task 4: Testes (AC: todos)
  - [x] 4.1 `tests/sca-engine/context-generator.test.js` â€” 9 tests
  - [x] 4.2 Fixture: `tests/fixtures/configs/squad-context-map.yaml`
- [x] Task 5: ValidaÃ§Ã£o final
  - [x] 5.1 80/80 testes passando, lint limpo

## Dev Notes

### DependÃªncia

**Depende de Story 1.3** â€” usa composer.js para blocos e parser.js para substratos.

### Arquitetura Relevante

**ContextFrontmatter Schema** [Source: architecture/nexus-architecture-v1.md#4.4]:
```javascript
const ContextFrontmatter = z.object({
  project: z.string(),
  squad: z.string(),
  generated_at: z.string().datetime(),
  substrates_included: z.array(z.string()),
  blocks_included: z.array(z.string()),
  stale_blocks: z.array(z.string()).default([]),
})
```

**Context File:** `docs/knowledge/{project}/contexts/{squad}-context.md`

**Key Implementation** [Source: architecture/nexus-architecture-v1.md#11.3]:
```javascript
export async function generateContext(project, squad) {
  const squadNeeds = loadSquadNeeds(squad)
  const substrates = await loadSubstratesByCategory(project, squadNeeds.categories)
  const blocks = await loadBlocksByStage(project, squadNeeds.funnel_stages)
  const staleBlocks = blocks.filter(b => b.frontmatter.status === 'stale')
  const manifest = loadManifest(project)
  return compileContextDocument({ manifest, substrates, blocks, squad, staleBlocks })
}
```

**squad-context-map.yaml** [Source: architecture/nexus-architecture-v1.md#11.5]:
```yaml
direct-response-creator:
  categories: [product, pain, solution, objection, differentiator, proof, offer, audience]
  funnel_stages: [awareness, consideration, decision]
agencia-squad:
  categories: [product, audience, differentiator, proof]
  funnel_stages: [awareness, consideration]
design-extractor-squad:
  categories: [identity, product]
  funnel_stages: []
vendas-canhotos-squad:
  categories: [product, pain, solution, objection, offer, proof]
  funnel_stages: [consideration, decision]
pitch-investimento-squad:
  categories: [identity, product, differentiator, proof, context]
  funnel_stages: [awareness, consideration, decision]
```

**Performance Target** [Source: architecture/nexus-architecture-v1.md#15.2]:
- `*context generate` < 1s

### Testing

- Framework: Vitest, globals: true
- Location: `tests/sca-engine/`
- Key tests: generate com squad vÃ¡lido, preview dry-run, stale blocks warning, missing substrates

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-25 | 0.1 | Story criada | River (SM) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
- Nenhum issue â€” tudo passou de primeira

### Completion Notes List
- 80/80 testes (9 novos), lint limpo
- Todos os 6 ACs implementados
- Context generator com squad mapping, substrate/block filtering, stale detection
- CLI: context generate/preview

### File List
| File | Action | Description |
|------|--------|-------------|
| `src/sca-engine/context-generator.js` | Created | Full context generation pipeline |
| `src/sca-engine/index.js` | Modified | Added context-generator exports |
| `src/cli/context.js` | Created | CLI: generate, preview |
| `src/cli/index.js` | Modified | Added context command |
| `config/squad-context-map.yaml` | Created | Squad-to-categories mapping |
| `tests/sca-engine/context-generator.test.js` | Created | 9 tests |
| `tests/fixtures/configs/squad-context-map.yaml` | Created | Test fixture |

## QA Results
_To be filled by QA agent_
