# Story 1.4: Context Generator (SCA Output Engine)

## Status

Draft

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: [integration_review, pattern_validation]

## Story

**As a** NEXUS operator,
**I want** to generate compiled context ready to feed any squad,
**so that** agents receive relevant substrates + blocks automatically.

## Acceptance Criteria

1. Comando `*context generate {project} --for {squad}` produz `context.md`
2. Mapeamento em `config/squad-context-map.yaml` define quais categorias cada squad precisa
3. O `context.md` inclui: header, substratos relevantes, blocos compilados, instruÃ§Ãµes
4. Comando `*context preview` mostra preview sem salvar (dry-run)
5. Salvo em `docs/knowledge/{project}/contexts/{squad}-context.md`
6. Valida que substratos existem e nenhum bloco estÃ¡ `[STALE]`

## ðŸ¤– CodeRabbit Integration

> **CodeRabbit Integration**: Disabled

## Tasks / Subtasks

- [ ] Task 1: Implementar Context Generator (AC: 1, 2, 3, 5, 6)
  - [ ] 1.1 Criar `src/sca-engine/context-generator.js`:
    - `generateContext(project, squad)` â†’ context.md compilado
    - `loadSquadNeeds(squad)` â†’ lÃª squad-context-map.yaml
    - `loadSubstratesByCategory(project, categories)` â†’ substratos filtrados
    - `loadBlocksByStage(project, stages)` â†’ blocos filtrados
    - `compileContextDocument({ manifest, substrates, blocks, squad, staleBlocks })` â†’ markdown
  - [ ] 1.2 ValidaÃ§Ã£o: substratos existem, blocos nÃ£o estÃ£o stale (warning, nÃ£o block)
- [ ] Task 2: Criar config file (AC: 2)
  - [ ] 2.1 Criar `config/squad-context-map.yaml` com mapeamentos dos 5 squads da arquitetura
- [ ] Task 3: Implementar CLI Context commands (AC: 1, 4)
  - [ ] 3.1 Criar `src/cli/context.js` â€” Commander: `generate`, `preview`
  - [ ] 3.2 Preview mode: mostra output sem salvar
- [ ] Task 4: Testes (AC: todos)
  - [ ] 4.1 `tests/sca-engine/context-generator.test.js` â€” generate, preview, stale warning, missing substrates
  - [ ] 4.2 Fixture: `tests/fixtures/configs/squad-context-map.yaml`
- [ ] Task 5: ValidaÃ§Ã£o final
  - [ ] 5.1 `npm run validate` passa

## Dev Notes

### DependÃªncia

**Depende de Story 1.3** â€” usa composer.js para blocos e parser.js para substratos.

### Arquitetura Relevante

**ContextFrontmatter Schema** [Source: architecture/nexus-architecture-v1.md#4.4]:
```javascript
const ContextFrontmatter = z.object({
  project: z.string(),
  squad: z.string(),
  generated_at: z.string().datetime(),
  substrates_included: z.array(z.string()),
  blocks_included: z.array(z.string()),
  stale_blocks: z.array(z.string()).default([]),
})
```

**Context File:** `docs/knowledge/{project}/contexts/{squad}-context.md`

**Key Implementation** [Source: architecture/nexus-architecture-v1.md#11.3]:
```javascript
export async function generateContext(project, squad) {
  const squadNeeds = loadSquadNeeds(squad)
  const substrates = await loadSubstratesByCategory(project, squadNeeds.categories)
  const blocks = await loadBlocksByStage(project, squadNeeds.funnel_stages)
  const staleBlocks = blocks.filter(b => b.frontmatter.status === 'stale')
  const manifest = loadManifest(project)
  return compileContextDocument({ manifest, substrates, blocks, squad, staleBlocks })
}
```

**squad-context-map.yaml** [Source: architecture/nexus-architecture-v1.md#11.5]:
```yaml
direct-response-creator:
  categories: [product, pain, solution, objection, differentiator, proof, offer, audience]
  funnel_stages: [awareness, consideration, decision]
agencia-squad:
  categories: [product, audience, differentiator, proof]
  funnel_stages: [awareness, consideration]
design-extractor-squad:
  categories: [identity, product]
  funnel_stages: []
vendas-canhotos-squad:
  categories: [product, pain, solution, objection, offer, proof]
  funnel_stages: [consideration, decision]
pitch-investimento-squad:
  categories: [identity, product, differentiator, proof, context]
  funnel_stages: [awareness, consideration, decision]
```

**Performance Target** [Source: architecture/nexus-architecture-v1.md#15.2]:
- `*context generate` < 1s

### Testing

- Framework: Vitest, globals: true
- Location: `tests/sca-engine/`
- Key tests: generate com squad vÃ¡lido, preview dry-run, stale blocks warning, missing substrates

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-25 | 0.1 | Story criada | River (SM) |

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results
_To be filled by QA agent_
