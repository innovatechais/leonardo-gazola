# Story 1.1: Project Registry & Structure

## Status

Ready for Review

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: [pattern_validation, schema_review]

## Story

**As a** NEXUS operator,
**I want** to register projects with standardized metadata and structure,
**so that** each project has its own isolated knowledge namespace.

## Acceptance Criteria

1. Comando `*project create {slug}` cria estrutura `docs/knowledge/{slug}/` com `manifest.yaml`
2. Comando `*project list` exibe todos os projetos registrados com status
3. Comando `*project select {slug}` define o projeto ativo (persiste em `.aios/session.yaml`)
4. Comando `*project status` mostra projeto ativo com contagem de substratos, blocos e outputs
5. Projetos `innovatech`, `evidex` e `ipro` sÃ£o registrados como seed data
6. O `manifest.yaml` inclui campo `visibility: public|private` para separaÃ§Ã£o futura

## ğŸ¤– CodeRabbit Integration

> **CodeRabbit Integration**: Disabled
>
> CodeRabbit CLI is not enabled in `core-config.yaml`.
> Quality validation will use manual review process only.
> To enable, set `coderabbit_integration.enabled: true` in core-config.yaml

## Tasks / Subtasks

- [x] Task 1: Setup do projeto Node.js (AC: todos)
  - [x] 1.1 Criar `package.json` conforme arquitetura (ESM, 6 deps, devDeps)
  - [x] 1.2 Criar `vitest.config.js` com configuraÃ§Ã£o da arquitetura
  - [x] 1.3 Criar `eslint.config.js` com regras da arquitetura
  - [x] 1.4 Rodar `npm install`
- [x] Task 2: Criar shared modules (AC: todos)
  - [x] 2.1 Criar `src/shared/schemas.js` â€” schemas Zod: ProjectManifest, SubstrateCategory, SubstrateFrontmatter (importar de arquitetura seÃ§Ã£o 4)
  - [x] 2.2 Criar `src/shared/fs-utils.js` â€” `readWithFrontmatter()`, `writeWithFrontmatter()`, `ensureDir()`
  - [x] 2.3 Criar `src/shared/paths.js` â€” path resolver centralizado (`projectDir()`, `substratesDir()`, `blocksDir()`, `contextsDir()`, `outputsDir()`, `sessionFile()`)
  - [x] 2.4 Criar `src/shared/errors.js` â€” hierarchy completa: `NexusError`, `ValidationError`, `NotFoundError`, `ProjectNotFoundError`, etc.
  - [x] 2.5 Criar `src/shared/constants.js` â€” `MAX_WORD_COUNT`, `FUNNEL_STAGES`, `SUBSTRATE_CATEGORIES`, `VISIBILITY_LEVELS`, theme object
- [x] Task 3: Implementar Project Registry (AC: 1, 2, 4)
  - [x] 3.1 Criar `src/project/registry.js` â€” `createProject(slug, metadata)`, `listProjects()`, `getProject(slug)`
  - [x] 3.2 Criar `src/project/session.js` â€” `selectProject(slug)`, `getActiveProject()` via `.aios/session.yaml`
  - [x] 3.3 Criar `src/project/visibility.js` â€” `setVisibility(slug, level)`, `getVisibility(slug)`
  - [x] 3.4 Criar `src/project/index.js` â€” API pÃºblica do mÃ³dulo
- [x] Task 4: Implementar CLI commands (AC: 1, 2, 3, 4)
  - [x] 4.1 Criar `src/cli/project.js` â€” Commander.js commands: `create`, `list`, `select`, `status`
- [x] Task 5: Seed data (AC: 5, 6)
  - [x] 5.1 Criar `docs/knowledge/innovatech/manifest.yaml` com dados reais
  - [x] 5.2 Criar `docs/knowledge/evidex/manifest.yaml` com dados reais
  - [x] 5.3 Criar `docs/knowledge/ipro/manifest.yaml` com dados reais
  - [x] 5.4 Criar subdirs: `substrates/`, `blocks/`, `contexts/`, `outputs/` para cada
- [x] Task 6: Testes unitÃ¡rios (AC: todos)
  - [x] 6.1 Criar `tests/shared/schemas.test.js` â€” validaÃ§Ã£o Zod (vÃ¡lido + invÃ¡lido)
  - [x] 6.2 Criar `tests/shared/fs-utils.test.js` â€” read/write com frontmatter
  - [x] 6.3 Criar `tests/project/registry.test.js` â€” CRUD + listagem
  - [x] 6.4 Criar `tests/project/session.test.js` â€” select/get active
  - [x] 6.5 Criar `tests/project/visibility.test.js` â€” set/get visibility
  - [x] 6.6 Criar fixtures: `tests/fixtures/projects/test-project/manifest.yaml`, `tests/fixtures/projects/personal-project/manifest.yaml`
- [x] Task 7: ValidaÃ§Ã£o final
  - [x] 7.1 `npm run lint` passa
  - [x] 7.2 `npm test` passa (42/42)

## Dev Notes

### Arquitetura Relevante

**Tech Stack** [Source: architecture/nexus-architecture-v1.md#3]:
- Node.js 22, ESM only (`"type": "module"`)
- JavaScript puro (sem TypeScript no MVP)
- 6 deps: commander, fs-extra, glob, gray-matter, js-yaml, zod
- DevDeps: eslint 9.x, vitest 2.x, @vitest/coverage-v8
- Package manager: npm

**Module Pattern** [Source: architecture/nexus-architecture-v1.md#11.2]:
```javascript
// ESM, funÃ§Ãµes puras, Zod via shared, fs via fs-utils
import yaml from 'js-yaml'
import { readWithFrontmatter } from '../shared/fs-utils.js'
import { paths } from '../shared/paths.js'
import { ValidationError } from '../shared/errors.js'

const MAX_WORD_COUNT = 200

export function publicFunction(param) { /* ... */ }
function internalHelper() { /* ... */ }
```

**ProjectManifest Schema** [Source: architecture/nexus-architecture-v1.md#4.1]:
```javascript
const ProjectManifest = z.object({
  slug: z.string().regex(/^[a-z0-9-]+$/),
  name: z.string().min(1),
  description: z.string().optional(),
  visibility: z.enum(['public', 'private', 'personal']).default('private'),
  market_profile: z.string().default('pt-br-massa'),
  tone: z.string().default('professional'),
  created_at: z.string().datetime(),
  tags: z.array(z.string()).default([]),
  shared_substrates: z.array(z.string()).default([]),
  design_system: z.string().optional(),
})
```

**Project Registry Interfaces** [Source: architecture/nexus-architecture-v1.md#6.4]:
- `createProject(slug, metadata)` â†’ cria diretÃ³rio + manifest
- `listProjects()` â†’ `ProjectManifest[]`
- `selectProject(slug)` â†’ persiste em `.aios/session.yaml`
- `getActiveProject()` â†’ `ProjectManifest`

**Project Structure** [Source: architecture/nexus-architecture-v1.md#12]:
```
src/project/
â”œâ”€â”€ registry.js        # CRUD de projetos
â”œâ”€â”€ session.js         # Projeto ativo
â”œâ”€â”€ cloner.js          # (Story 4.1)
â”œâ”€â”€ visibility.js      # Controle de visibilidade
â””â”€â”€ index.js           # API pÃºblica
```

**Shared Modules** [Source: architecture/nexus-architecture-v1.md#11.1]:
```
src/shared/
â”œâ”€â”€ schemas.js         # Schemas Zod centralizados
â”œâ”€â”€ fs-utils.js        # readWithFrontmatter, writeWithFrontmatter
â”œâ”€â”€ paths.js           # Path resolver centralizado
â”œâ”€â”€ constants.js       # Enums, defaults, limites
â””â”€â”€ errors.js          # Error types padronizados
```

**Error Hierarchy** [Source: architecture/nexus-architecture-v1.md#18]:
```
NexusError (base)
â”œâ”€â”€ ValidationError (SchemaError, DuplicateIdError, WordCountExceededError)
â”œâ”€â”€ NotFoundError (ProjectNotFoundError, SubstrateNotFoundError, etc.)
â”œâ”€â”€ SecurityError (VisibilityError, SensitiveContentError)
â””â”€â”€ ...
```

**Naming Conventions** [Source: architecture/nexus-architecture-v1.md#17.2]:
- Files: kebab-case (`context-generator.js`)
- Functions: camelCase (`generateContext()`)
- Constants: UPPER_SNAKE (`MAX_WORD_COUNT`)
- Schemas: PascalCase (`SubstrateFrontmatter`)
- Errors: PascalCase+Error (`SubstrateNotFoundError`)

**Critical Rules** [Source: architecture/nexus-architecture-v1.md#17.1]:
- ESM Only â€” `import/export`, zero `require()`
- Schemas in shared/ â€” Zod centralizado
- Paths via resolver â€” Nunca string concatenation
- Frontmatter via fs-utils â€” Nunca gray-matter direto
- Validate before write â€” Zod parse antes de persistir
- Errors are typed â€” Classes de errors.js

**Seed Data Existente** â€” os projetos innovatech, evidex e ipro jÃ¡ existem em `docs/knowledge/` com substratos. Os manifests precisam ser criados no formato padronizado.

**CLI Output Theme** [Source: architecture/nexus-architecture-v1.md#10.1]:
```javascript
export const theme = {
  success: 'âœ…', warning: 'âš ï¸', error: 'âŒ', info: 'â„¹ï¸',
  project: 'ğŸ“', substrate: 'ğŸ§¬', block: 'ğŸ§±', context: 'ğŸ“‹',
  output: 'ğŸ“„', squad: 'ğŸ‘¥', campaign: 'ğŸš€', pipeline: 'â›“ï¸',
}
```

### Testing

[Source: architecture/nexus-architecture-v1.md#16]:
- Framework: Vitest 2.x
- Location: `tests/` (mirrors src/ structure)
- Globals: true (no import needed for describe/it/expect)
- Coverage: v8 provider, threshold 85% lines/functions, 80% branches
- Fixtures: `tests/fixtures/`
- Pattern: `tests/{module}/{file}.test.js`

**Vitest Config:**
```javascript
import { defineConfig } from 'vitest/config'
export default defineConfig({
  test: {
    globals: true,
    environment: 'node',
    include: ['tests/**/*.test.js'],
    coverage: {
      provider: 'v8',
      include: ['src/**/*.js'],
      exclude: ['src/cli/formatters/**'],
      thresholds: { global: { lines: 85, branches: 80, functions: 85 } },
    },
  },
})
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-25 | 0.1 | Story criada | River (SM) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
- Lint fix: `src/project/registry.js:38` â€” prefer-template (string concatenation â†’ template literal)
- Test isolation fix: `src/shared/paths.js` â€” `NEXUS_ROOT` was cached at import time, changed to dynamic read
- Test parallelism fix: `vitest.config.js` â€” added `fileParallelism: false` to prevent env var conflicts
- Test assertion fix: `tests/shared/fs-utils.test.js:56` â€” js-yaml doesn't quote simple strings

### Completion Notes List
- 42/42 testes passando, lint limpo
- Todos os 6 ACs implementados
- 3 seed projects criados (innovatech, evidex, ipro) com subdirs
- Error hierarchy completa com 14 classes de erro
- CLI commands: create, list, select, status

### File List
| File | Action | Description |
|------|--------|-------------|
| `package.json` | Modified | ESM config, deps, scripts |
| `vitest.config.js` | Created | Vitest config with coverage thresholds |
| `eslint.config.js` | Created | ESLint 9 flat config |
| `src/shared/schemas.js` | Created | Zod schemas (ProjectManifest, Substrate, Block, Context) |
| `src/shared/errors.js` | Created | Error hierarchy (14 classes) |
| `src/shared/paths.js` | Created | Centralized path resolver |
| `src/shared/fs-utils.js` | Created | Frontmatter read/write, YAML utils |
| `src/shared/constants.js` | Created | Constants, enums, theme |
| `src/project/registry.js` | Created | Project CRUD + stats |
| `src/project/session.js` | Created | Active project session |
| `src/project/visibility.js` | Created | Visibility management |
| `src/project/index.js` | Created | Public API re-exports |
| `src/cli/project.js` | Created | Commander.js project commands |
| `src/cli/index.js` | Created | CLI entry point |
| `docs/knowledge/innovatech/manifest.yaml` | Created | Seed: Innovatech |
| `docs/knowledge/evidex/manifest.yaml` | Created | Seed: Evidex |
| `docs/knowledge/ipro/manifest.yaml` | Created | Seed: iPro |
| `tests/shared/schemas.test.js` | Created | 15 schema tests |
| `tests/shared/fs-utils.test.js` | Created | 6 fs-utils tests |
| `tests/project/registry.test.js` | Created | 9 registry tests |
| `tests/project/session.test.js` | Created | 7 session tests |
| `tests/project/visibility.test.js` | Created | 5 visibility tests |
| `tests/fixtures/projects/test-project/manifest.yaml` | Created | Test fixture |
| `tests/fixtures/projects/personal-project/manifest.yaml` | Created | Test fixture |

## QA Results
_To be filled by QA agent_
