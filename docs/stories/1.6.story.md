# Story 1.6: Substrate Importer

## Status

Ready for Review

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: [code_review, integration_review]

## Story

**As a** NEXUS operator,
**I want** to import existing documents and transform them into categorized substrates,
**so that** I don't rewrite manually what already exists.

## Acceptance Criteria

1. Comando `*substrate import {file-path}` analisa documento e sugere split em substratos
2. Preview com numeraÃ§Ã£o e categorizaÃ§Ã£o proposta
3. UsuÃ¡rio aprova todos, edita individualmente ou rejeita
4. Suporta markdown, texto, JSON
5. Cria com frontmatter e source para rastreabilidade
6. Teste: importar Base Comercial e verificar equivalÃªncia

## ðŸ¤– CodeRabbit Integration

> **CodeRabbit Integration**: Disabled

## Tasks / Subtasks

- [x] Task 1: Implementar Capture Engine modules (AC: 1, 2, 4, 5)
  - [x] 1.1 Criar `src/capture/index.js` â€” API pÃºblica
  - [x] 1.2 Criar `src/capture/importer.js` â€” importFile with format detection
  - [x] 1.3 Criar `src/capture/splitter.js` â€” split by headers/paragraphs/keys, respects 200 word limit
  - [x] 1.4 Criar `src/capture/categorizer.js` â€” keyword-based categorization
- [x] Task 2: Implementar CLI command (AC: 1, 2, 3)
  - [x] 2.1 Criar `src/cli/capture.js` â€” import with preview table
  - [x] 2.2 Preview com tabela formatada
  - [x] 2.3 --approve-all flag para auto-aprovaÃ§Ã£o
  - [x] 2.4 Source tracking no frontmatter
- [x] Task 3: Testes (AC: todos)
  - [x] 3.1 `tests/capture/splitter.test.js` â€” 10 tests
  - [x] 3.2 `tests/capture/categorizer.test.js` â€” 9 tests
  - [x] 3.3 `tests/capture/importer.test.js` â€” 5 tests
- [x] Task 4: ValidaÃ§Ã£o final
  - [x] 4.1 112/112 testes passando, lint limpo

## Dev Notes

### DependÃªncia

**Depende de Story 1.2** â€” usa parser.js, validator.js, writer.js para criar substratos.

### Arquitetura Relevante

**Capture Engine Structure** [Source: architecture/nexus-architecture-v1.md#6.6]:
```
src/capture/
â”œâ”€â”€ index.js
â”œâ”€â”€ importer.js        # importFile()
â”œâ”€â”€ splitter.js        # splitDocument()
â”œâ”€â”€ categorizer.js     # categorize()
â””â”€â”€ processor.js       # (Story 4.3)
```

**Key Interface** [Source: architecture/nexus-architecture-v1.md#6.6]:
- `importFile(filePath, project)` â†’ `SubstrateSuggestion[]`

**Import Flow** [Source: architecture/nexus-architecture-v1.md#8.3]:
1. Read file â†’ analyze + split em chunks <= 200 palavras
2. Categorize cada chunk
3. Preview com numeraÃ§Ã£o
4. UsuÃ¡rio aprova/edita/rejeita
5. Cria substratos com frontmatter e `source` para rastreabilidade

**Substrate Categories (para categorizer)** [Source: architecture/nexus-architecture-v1.md#4.2]:
identity, product, pain, solution, objection, differentiator, proof, offer, audience, context

**Formatos suportados:**
- Markdown: split por headers (`##`, `###`)
- Texto: split por parÃ¡grafos (double newline)
- JSON: split por top-level keys

### Testing

- Framework: Vitest, globals: true
- Location: `tests/capture/`
- Key tests: split com diferentes formatos, categorizaÃ§Ã£o, fluxo completo
- Integration test: importar fixture e verificar substratos gerados

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-25 | 0.1 | Story criada | River (SM) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
- Splitter fix: single paragraph >200 words wasn't being split; added force-split by word count

### Completion Notes List
- 112/112 testes (24 novos), lint limpo
- Todos os 6 ACs implementados
- Capture engine: importer, splitter (md/txt/json), categorizer (keyword heuristics)
- CLI: capture import with preview table and --approve-all

### File List
| File | Action | Description |
|------|--------|-------------|
| `src/capture/index.js` | Created | Public API |
| `src/capture/importer.js` | Created | File import with format detection |
| `src/capture/splitter.js` | Created | Document splitter (md/txt/json) |
| `src/capture/categorizer.js` | Created | Keyword-based categorization |
| `src/cli/capture.js` | Created | CLI: import with preview |
| `src/cli/index.js` | Modified | Added capture command |
| `tests/capture/splitter.test.js` | Created | 10 tests |
| `tests/capture/categorizer.test.js` | Created | 9 tests |
| `tests/capture/importer.test.js` | Created | 5 tests |

## QA Results
_To be filled by QA agent_
