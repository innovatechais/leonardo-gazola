# Story 1.2: Substrate CRUD & Validation

## Status

Ready for Review

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: [schema_validation, code_review]

## Story

**As a** NEXUS operator,
**I want** to create, edit, list and validate substrates within a project,
**so that** primordial documents are standardized and ready for composition.

## Acceptance Criteria

1. Comando `*substrate create {id}` inicia elicitaÃ§Ã£o: tÃ­tulo, conteÃºdo (max 200 palavras), categoria
2. Comando `*substrate list` exibe tabela (ID, tÃ­tulo, categoria, palavras, versÃ£o)
3. Comando `*substrate view {id}` mostra conteÃºdo completo com metadados
4. Comando `*substrate edit {id}` permite editar â€” cria nova versÃ£o (histÃ³rico via git)
5. ValidaÃ§Ã£o: rejeita > 200 palavras; alerta se categoria jÃ¡ tem substrato
6. Substratos como markdown com frontmatter: `docs/knowledge/{project}/substrates/S{n}-{slug}.md`
7. Substratos existentes (Innovatech, Evidex, iPro) migrados para formato padronizado

## ðŸ¤– CodeRabbit Integration

> **CodeRabbit Integration**: Disabled

## Tasks / Subtasks

- [x] Task 1: Implementar SCA Engine â€” Parser + Validator (AC: 1, 5, 6)
  - [x] 1.1 Criar `src/sca-engine/index.js` â€” API pÃºblica
  - [x] 1.2 Criar `src/sca-engine/parser.js` â€” `parseSubstrate(filePath)` retorna `{ frontmatter, content, wordCount }`
  - [x] 1.3 Criar `src/sca-engine/validator.js` â€” `validateSubstrate(data)` com Zod + word count + duplicate check
  - [x] 1.4 Criar `src/sca-engine/writer.js` â€” `writeSubstrate(project, data)` serializa frontmatter + content
- [x] Task 2: Implementar CLI Substrate commands (AC: 1, 2, 3, 4)
  - [x] 2.1 Criar `src/cli/substrate.js` â€” Commander: `create`, `list`, `view`, `edit`
  - [x] 2.2 FormataÃ§Ã£o de lista como tabela (ID, tÃ­tulo, categoria, palavras, status)
- [x] Task 3: Security module (AC: 5)
  - [x] 3.1 Criar `src/shared/security.js` â€” `scanSensitiveContent(text)` com patterns: email, CPF, API tokens
- [x] Task 4: Migrar substratos existentes (AC: 7)
  - [x] 4.1 Auditar `docs/knowledge/innovatech/` e criar substratos padronizados (S1, S2)
  - [x] 4.2 Auditar `docs/knowledge/evidex/` e criar substratos padronizados (S1, S2)
  - [x] 4.3 Auditar `docs/knowledge/ipro/` e criar substratos padronizados (S1)
- [x] Task 5: Testes (AC: todos)
  - [x] 5.1 `tests/sca-engine/parser.test.js` â€” 4 tests
  - [x] 5.2 `tests/sca-engine/validator.test.js` â€” 11 tests
  - [x] 5.3 `tests/shared/security.test.js` â€” 8 tests
  - [x] 5.4 Criar fixtures: S1-valid, S2-valid, S99-too-long, S98-bad-frontmatter, S97-sensitive
- [x] Task 6: ValidaÃ§Ã£o final
  - [x] 6.1 65/65 testes passando, lint limpo

## Dev Notes

### DependÃªncia

**Depende de Story 1.1** â€” usa `shared/schemas.js`, `shared/fs-utils.js`, `shared/paths.js`, `shared/errors.js`, `shared/constants.js` e `project/registry.js` (para getActiveProject).

### Arquitetura Relevante

**SubstrateFrontmatter Schema** [Source: architecture/nexus-architecture-v1.md#4.2]:
```javascript
const SubstrateCategory = z.enum([
  'identity', 'product', 'pain', 'solution', 'objection',
  'differentiator', 'proof', 'offer', 'audience', 'context',
])

const SubstrateFrontmatter = z.object({
  id: z.string().regex(/^S\d+$/),
  title: z.string().min(1),
  category: SubstrateCategory,
  version: z.number().int().positive().default(1),
  status: z.enum(['draft', 'approved', 'deprecated']).default('draft'),
  created_at: z.string().datetime(),
  updated_at: z.string().datetime(),
  source: z.string().optional(),
})
```

**SCA Engine Structure** [Source: architecture/nexus-architecture-v1.md#6.1]:
```
src/sca-engine/
â”œâ”€â”€ parser.js          # Parse markdown + frontmatter
â”œâ”€â”€ validator.js       # ValidaÃ§Ã£o Zod (schema, word count, refs)
â”œâ”€â”€ writer.js          # Serializa e escreve com frontmatter
â”œâ”€â”€ composer.js        # (Story 1.3)
â”œâ”€â”€ context-generator.js  # (Story 1.4)
â”œâ”€â”€ impact.js          # (Story 1.5)
â”œâ”€â”€ health.js          # (Story 1.5)
â””â”€â”€ index.js           # API pÃºblica
```

**Key Interfaces** [Source: architecture/nexus-architecture-v1.md#6.1]:
- `parseSubstrate(filePath)` â†’ `{ frontmatter, content, wordCount }`

**Substrate File Format** [Source: architecture/nexus-architecture-v1.md#9.2]:
```yaml
---
id: S1
title: "O que Ã© o Evidex"
category: product
version: 1
status: approved
created_at: 2026-02-25T00:00:00Z
updated_at: 2026-02-25T00:00:00Z
source: null
---
{conteÃºdo markdown â€” max 200 palavras}
```

**Naming:** `S{n}-{slug}.md` em `docs/knowledge/{project}/substrates/`

**Sensitive Content Patterns** [Source: architecture/nexus-architecture-v1.md#15.1]:
```javascript
const SENSITIVE_PATTERNS = [
  /\b[\w.-]+@[\w.-]+\.\w{2,}\b/,        // email
  /\b\d{3}\.?\d{3}\.?\d{3}-?\d{2}\b/,   // CPF
  /\b(?:sk-|pk_|token_|Bearer )\S+/,      // API tokens
]
```

**Performance Target** [Source: architecture/nexus-architecture-v1.md#15.2]:
- `*substrate list` < 200ms
- Use frontmatter-only parsing when listing

**CLI Output â€” Lista** [Source: architecture/nexus-architecture-v1.md#10.2]:
```
ðŸ§¬ Substratos â€” evidex (12 total)

 ID   â”‚ TÃ­tulo                    â”‚ Categoria     â”‚ Palavras â”‚ Status
â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€
 S1   â”‚ O que Ã© o Evidex          â”‚ product       â”‚ 142      â”‚ approved
```

### Testing

- Framework: Vitest 2.x, globals: true
- Location: `tests/sca-engine/`, `tests/shared/`
- Fixtures: `tests/fixtures/substrates/`
- Coverage target: validator.js 95%+, security.js 100%

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-25 | 0.1 | Story criada | River (SM) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
- Nenhum issue encontrado â€” lint e testes passaram de primeira

### Completion Notes List
- 65/65 testes (23 novos), lint limpo
- Todos os 7 ACs implementados
- SCA engine: parser, validator, writer
- Security module com detecÃ§Ã£o de email, CPF, API tokens
- 5 substratos seed migrados (2 innovatech, 2 evidex, 1 ipro)
- CLI: substrate create/list/view/edit

### File List
| File | Action | Description |
|------|--------|-------------|
| `src/sca-engine/index.js` | Created | Public API |
| `src/sca-engine/parser.js` | Created | Parse substrate markdown+frontmatter |
| `src/sca-engine/validator.js` | Created | Schema, word count, duplicate, sensitive validation |
| `src/sca-engine/writer.js` | Created | Serialize and write substrate files |
| `src/shared/security.js` | Created | Sensitive content scanner |
| `src/cli/substrate.js` | Created | CLI commands: create, list, view, edit |
| `src/cli/index.js` | Modified | Added substrate command |
| `docs/knowledge/innovatech/substrates/S1-quem-somos.md` | Created | Seed substrate |
| `docs/knowledge/innovatech/substrates/S2-proposta-de-valor.md` | Created | Seed substrate |
| `docs/knowledge/evidex/substrates/S1-o-que-e-evidex.md` | Created | Seed substrate |
| `docs/knowledge/evidex/substrates/S2-dor-do-mercado.md` | Created | Seed substrate |
| `docs/knowledge/ipro/substrates/S1-o-que-e-ipro.md` | Created | Seed substrate |
| `tests/sca-engine/parser.test.js` | Created | 4 parser tests |
| `tests/sca-engine/validator.test.js` | Created | 11 validator tests |
| `tests/shared/security.test.js` | Created | 8 security tests |
| `tests/fixtures/substrates/S1-valid.md` | Created | Test fixture |
| `tests/fixtures/substrates/S2-valid.md` | Created | Test fixture |
| `tests/fixtures/substrates/S97-sensitive.md` | Created | Test fixture |
| `tests/fixtures/substrates/S98-bad-frontmatter.md` | Created | Test fixture |
| `tests/fixtures/substrates/S99-too-long.md` | Created | Test fixture |

## QA Results
_To be filled by QA agent_
