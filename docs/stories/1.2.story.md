# Story 1.2: Substrate CRUD & Validation

## Status

Draft

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: [schema_validation, code_review]

## Story

**As a** NEXUS operator,
**I want** to create, edit, list and validate substrates within a project,
**so that** primordial documents are standardized and ready for composition.

## Acceptance Criteria

1. Comando `*substrate create {id}` inicia elicitaÃ§Ã£o: tÃ­tulo, conteÃºdo (max 200 palavras), categoria
2. Comando `*substrate list` exibe tabela (ID, tÃ­tulo, categoria, palavras, versÃ£o)
3. Comando `*substrate view {id}` mostra conteÃºdo completo com metadados
4. Comando `*substrate edit {id}` permite editar â€” cria nova versÃ£o (histÃ³rico via git)
5. ValidaÃ§Ã£o: rejeita > 200 palavras; alerta se categoria jÃ¡ tem substrato
6. Substratos como markdown com frontmatter: `docs/knowledge/{project}/substrates/S{n}-{slug}.md`
7. Substratos existentes (Innovatech, Evidex, iPro) migrados para formato padronizado

## ðŸ¤– CodeRabbit Integration

> **CodeRabbit Integration**: Disabled

## Tasks / Subtasks

- [ ] Task 1: Implementar SCA Engine â€” Parser + Validator (AC: 1, 5, 6)
  - [ ] 1.1 Criar `src/sca-engine/index.js` â€” API pÃºblica
  - [ ] 1.2 Criar `src/sca-engine/parser.js` â€” `parseSubstrate(filePath)` retorna `{ frontmatter, content, wordCount }`
  - [ ] 1.3 Criar `src/sca-engine/validator.js` â€” `validateSubstrate(data)` com Zod + word count + duplicate check
  - [ ] 1.4 Criar `src/sca-engine/writer.js` â€” `writeSubstrate(project, data)` serializa frontmatter + content
- [ ] Task 2: Implementar CLI Substrate commands (AC: 1, 2, 3, 4)
  - [ ] 2.1 Criar `src/cli/substrate.js` â€” Commander: `create`, `list`, `view`, `edit`
  - [ ] 2.2 FormataÃ§Ã£o de lista como tabela (ID, tÃ­tulo, categoria, palavras, status)
- [ ] Task 3: Security module (AC: 5)
  - [ ] 3.1 Criar `src/shared/security.js` â€” `scanSensitiveContent(text)` com patterns: email, CPF, API tokens
- [ ] Task 4: Migrar substratos existentes (AC: 7)
  - [ ] 4.1 Auditar `docs/knowledge/innovatech/` e criar substratos padronizados
  - [ ] 4.2 Auditar `docs/knowledge/evidex/` e criar substratos padronizados
  - [ ] 4.3 Auditar `docs/knowledge/ipro/` e criar substratos padronizados
- [ ] Task 5: Testes (AC: todos)
  - [ ] 5.1 `tests/sca-engine/parser.test.js` â€” parse vÃ¡lido, frontmatter invÃ¡lido, word count
  - [ ] 5.2 `tests/sca-engine/validator.test.js` â€” validaÃ§Ã£o completa: schema, 200 palavras, duplicados
  - [ ] 5.3 `tests/shared/security.test.js` â€” detection de emails, CPFs, tokens
  - [ ] 5.4 Criar fixtures: `tests/fixtures/substrates/S1-valid.md`, `S2-valid.md`, `S99-too-long.md`, `S98-bad-frontmatter.md`, `S97-sensitive.md`
- [ ] Task 6: ValidaÃ§Ã£o final
  - [ ] 6.1 `npm run validate` passa

## Dev Notes

### DependÃªncia

**Depende de Story 1.1** â€” usa `shared/schemas.js`, `shared/fs-utils.js`, `shared/paths.js`, `shared/errors.js`, `shared/constants.js` e `project/registry.js` (para getActiveProject).

### Arquitetura Relevante

**SubstrateFrontmatter Schema** [Source: architecture/nexus-architecture-v1.md#4.2]:
```javascript
const SubstrateCategory = z.enum([
  'identity', 'product', 'pain', 'solution', 'objection',
  'differentiator', 'proof', 'offer', 'audience', 'context',
])

const SubstrateFrontmatter = z.object({
  id: z.string().regex(/^S\d+$/),
  title: z.string().min(1),
  category: SubstrateCategory,
  version: z.number().int().positive().default(1),
  status: z.enum(['draft', 'approved', 'deprecated']).default('draft'),
  created_at: z.string().datetime(),
  updated_at: z.string().datetime(),
  source: z.string().optional(),
})
```

**SCA Engine Structure** [Source: architecture/nexus-architecture-v1.md#6.1]:
```
src/sca-engine/
â”œâ”€â”€ parser.js          # Parse markdown + frontmatter
â”œâ”€â”€ validator.js       # ValidaÃ§Ã£o Zod (schema, word count, refs)
â”œâ”€â”€ writer.js          # Serializa e escreve com frontmatter
â”œâ”€â”€ composer.js        # (Story 1.3)
â”œâ”€â”€ context-generator.js  # (Story 1.4)
â”œâ”€â”€ impact.js          # (Story 1.5)
â”œâ”€â”€ health.js          # (Story 1.5)
â””â”€â”€ index.js           # API pÃºblica
```

**Key Interfaces** [Source: architecture/nexus-architecture-v1.md#6.1]:
- `parseSubstrate(filePath)` â†’ `{ frontmatter, content, wordCount }`

**Substrate File Format** [Source: architecture/nexus-architecture-v1.md#9.2]:
```yaml
---
id: S1
title: "O que Ã© o Evidex"
category: product
version: 1
status: approved
created_at: 2026-02-25T00:00:00Z
updated_at: 2026-02-25T00:00:00Z
source: null
---
{conteÃºdo markdown â€” max 200 palavras}
```

**Naming:** `S{n}-{slug}.md` em `docs/knowledge/{project}/substrates/`

**Sensitive Content Patterns** [Source: architecture/nexus-architecture-v1.md#15.1]:
```javascript
const SENSITIVE_PATTERNS = [
  /\b[\w.-]+@[\w.-]+\.\w{2,}\b/,        // email
  /\b\d{3}\.?\d{3}\.?\d{3}-?\d{2}\b/,   // CPF
  /\b(?:sk-|pk_|token_|Bearer )\S+/,      // API tokens
]
```

**Performance Target** [Source: architecture/nexus-architecture-v1.md#15.2]:
- `*substrate list` < 200ms
- Use frontmatter-only parsing when listing

**CLI Output â€” Lista** [Source: architecture/nexus-architecture-v1.md#10.2]:
```
ðŸ§¬ Substratos â€” evidex (12 total)

 ID   â”‚ TÃ­tulo                    â”‚ Categoria     â”‚ Palavras â”‚ Status
â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€
 S1   â”‚ O que Ã© o Evidex          â”‚ product       â”‚ 142      â”‚ approved
```

### Testing

- Framework: Vitest 2.x, globals: true
- Location: `tests/sca-engine/`, `tests/shared/`
- Fixtures: `tests/fixtures/substrates/`
- Coverage target: validator.js 95%+, security.js 100%

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-25 | 0.1 | Story criada | River (SM) |

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results
_To be filled by QA agent_
