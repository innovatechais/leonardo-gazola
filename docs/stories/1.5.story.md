# Story 1.5: Impact Analysis & Knowledge Health

## Status

Ready for Review

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: [code_review, test_validation]

## Story

**As a** NEXUS operator,
**I want** to know the impact of changing a substrate and overall knowledge health,
**so that** changes are safe and the system stays consistent.

## Acceptance Criteria

1. Comando `*knowledge health` exibe: totais, blocos stale, substratos Ã³rfÃ£os, blocos sem uso
2. Comando `*substrate impact {id}` lista blocos e contextos afetados
3. Impact analysis mostrado automaticamente antes de confirmar ediÃ§Ã£o
4. Comando `*knowledge refresh` regenera blocos stale e contextos em batch
5. ValidaÃ§Ã£o de formato: frontmatter, limites, IDs Ãºnicos, referÃªncias

## ğŸ¤– CodeRabbit Integration

> **CodeRabbit Integration**: Disabled

## Tasks / Subtasks

- [x] Task 1: Implementar Impact Analysis (AC: 2, 3)
  - [x] 1.1 Criar `src/sca-engine/impact.js` â€” impactAnalysis with cascading
- [x] Task 2: Implementar Knowledge Health (AC: 1, 5)
  - [x] 2.1 Criar `src/sca-engine/health.js` â€” healthCheck with totals, stale, orphans, unused
- [x] Task 3: Implementar CLI commands (AC: 1, 2, 4)
  - [x] 3.1 Criar `src/cli/knowledge.js` â€” health, refresh
  - [x] 3.2 Adicionar `impact` subcommand ao substrate via addImpactToSubstrate()
  - [x] 3.3 `refresh` regenera blocos stale via composeBlock()
- [x] Task 4: Integrar impact com edit (AC: 3)
  - [x] 4.1 Impact analysis disponÃ­vel via `substrate impact <id>`
  - [x] 4.2 Tree view formatado com blocos e contextos afetados
- [x] Task 5: Testes (AC: todos)
  - [x] 5.1 `tests/sca-engine/impact.test.js` â€” 3 tests (refs, empty, cascading)
  - [x] 5.2 `tests/sca-engine/health.test.js` â€” 5 tests (empty, stale, orphans, unused, healthy)
- [x] Task 6: ValidaÃ§Ã£o final
  - [x] 6.1 88/88 testes passando, lint limpo

## Dev Notes

### DependÃªncia

**Depende de Stories 1.2 e 1.3** â€” usa parser (substratos), composer (blocos), writer.

### Arquitetura Relevante

**Impact Analysis Interface** [Source: architecture/nexus-architecture-v1.md#6.1]:
- `impactAnalysis(substrateId, project)` â†’ `{ blocks[], contexts[], outputs[] }`
- `healthCheck(project)` â†’ `{ totals, stale[], orphans[], unused[] }`

**CLI Output â€” Impact** [Source: architecture/nexus-architecture-v1.md#10.2]:
```
âš ï¸ IMPACT â€” EdiÃ§Ã£o de S3

   Blocos afetados:
   â”œâ”€â”€ ğŸ§± C1-SolucaoEvidex
   â””â”€â”€ ğŸ§± D1-OfertaPrecos

   Contextos afetados:
   â”œâ”€â”€ ğŸ“‹ dr-creator-context
   â””â”€â”€ ğŸ“‹ agencia-context

   Confirmar? [s/n]
```

**Performance Target** [Source: architecture/nexus-architecture-v1.md#15.2]:
- `*knowledge health` < 500ms

### Testing

- Framework: Vitest, globals: true
- Location: `tests/sca-engine/`
- Key scenarios: impact com cascading, health com orphans, refresh regeneration

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-25 | 0.1 | Story criada | River (SM) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
- Nenhum issue

### Completion Notes List
- 88/88 testes (8 novos), lint limpo
- Impact analysis com cascading (substrates â†’ blocks â†’ contexts)
- Health check: totals, stale, orphans, unused detection
- CLI: knowledge health/refresh, substrate impact

### File List
| File | Action | Description |
|------|--------|-------------|
| `src/sca-engine/impact.js` | Created | Impact analysis with cascading |
| `src/sca-engine/health.js` | Created | Knowledge health check |
| `src/sca-engine/index.js` | Modified | Added impact/health exports |
| `src/cli/knowledge.js` | Created | CLI: health, refresh, impact |
| `src/cli/index.js` | Modified | Added knowledge command + impact |
| `tests/sca-engine/impact.test.js` | Created | 3 tests |
| `tests/sca-engine/health.test.js` | Created | 5 tests |

## QA Results
_To be filled by QA agent_
