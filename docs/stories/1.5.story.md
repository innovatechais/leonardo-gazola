# Story 1.5: Impact Analysis & Knowledge Health

## Status

Draft

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: [code_review, test_validation]

## Story

**As a** NEXUS operator,
**I want** to know the impact of changing a substrate and overall knowledge health,
**so that** changes are safe and the system stays consistent.

## Acceptance Criteria

1. Comando `*knowledge health` exibe: totais, blocos stale, substratos Ã³rfÃ£os, blocos sem uso
2. Comando `*substrate impact {id}` lista blocos e contextos afetados
3. Impact analysis mostrado automaticamente antes de confirmar ediÃ§Ã£o
4. Comando `*knowledge refresh` regenera blocos stale e contextos em batch
5. ValidaÃ§Ã£o de formato: frontmatter, limites, IDs Ãºnicos, referÃªncias

## ğŸ¤– CodeRabbit Integration

> **CodeRabbit Integration**: Disabled

## Tasks / Subtasks

- [ ] Task 1: Implementar Impact Analysis (AC: 2, 3)
  - [ ] 1.1 Criar `src/sca-engine/impact.js`:
    - `impactAnalysis(substrateId, project)` â†’ `{ blocks[], contexts[], outputs[] }`
    - Busca todos blocos cujo `substrates[]` inclui o ID
    - Busca contextos que incluem esses blocos
- [ ] Task 2: Implementar Knowledge Health (AC: 1, 5)
  - [ ] 2.1 Criar `src/sca-engine/health.js`:
    - `healthCheck(project)` â†’ `{ totals, stale[], orphans[], unused[] }`
    - Totais: substratos, blocos, contextos, outputs
    - Stale: blocos com status 'stale'
    - Orphans: substratos nÃ£o referenciados por nenhum bloco
    - Unused: blocos nÃ£o referenciados por nenhum contexto
    - ValidaÃ§Ã£o de formato em batch
- [ ] Task 3: Implementar CLI commands (AC: 1, 2, 4)
  - [ ] 3.1 Criar `src/cli/knowledge.js` â€” Commander: `health`, `status`, `refresh`
  - [ ] 3.2 Adicionar `impact` subcommand ao `src/cli/substrate.js`
  - [ ] 3.3 `refresh` regenera blocos stale via composer.composeBlock()
- [ ] Task 4: Integrar impact com edit (AC: 3)
  - [ ] 4.1 Modificar `*substrate edit` para chamar `impactAnalysis()` antes de confirmar
  - [ ] 4.2 Mostrar output formatado (tree view com blocos e contextos afetados)
- [ ] Task 5: Testes (AC: todos)
  - [ ] 5.1 `tests/sca-engine/impact.test.js` â€” substrato com blocos, sem blocos, cascading
  - [ ] 5.2 `tests/sca-engine/health.test.js` â€” healthy project, stale blocks, orphans, unused
- [ ] Task 6: ValidaÃ§Ã£o final
  - [ ] 6.1 `npm run validate` passa

## Dev Notes

### DependÃªncia

**Depende de Stories 1.2 e 1.3** â€” usa parser (substratos), composer (blocos), writer.

### Arquitetura Relevante

**Impact Analysis Interface** [Source: architecture/nexus-architecture-v1.md#6.1]:
- `impactAnalysis(substrateId, project)` â†’ `{ blocks[], contexts[], outputs[] }`
- `healthCheck(project)` â†’ `{ totals, stale[], orphans[], unused[] }`

**CLI Output â€” Impact** [Source: architecture/nexus-architecture-v1.md#10.2]:
```
âš ï¸ IMPACT â€” EdiÃ§Ã£o de S3

   Blocos afetados:
   â”œâ”€â”€ ğŸ§± C1-SolucaoEvidex
   â””â”€â”€ ğŸ§± D1-OfertaPrecos

   Contextos afetados:
   â”œâ”€â”€ ğŸ“‹ dr-creator-context
   â””â”€â”€ ğŸ“‹ agencia-context

   Confirmar? [s/n]
```

**Performance Target** [Source: architecture/nexus-architecture-v1.md#15.2]:
- `*knowledge health` < 500ms

### Testing

- Framework: Vitest, globals: true
- Location: `tests/sca-engine/`
- Key scenarios: impact com cascading, health com orphans, refresh regeneration

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-25 | 0.1 | Story criada | River (SM) |

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results
_To be filled by QA agent_
